name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            ext: ""
            archive: tar.gz
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            ext: ""
            archive: tar.gz
          - os: macos-13
            target: x86_64-apple-darwin
            ext: ""
            archive: tar.gz
          - os: macos-14
            target: aarch64-apple-darwin
            ext: ""
            archive: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            ext: ".exe"
            archive: zip

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux cross-linker (arm64)
        if: runner.os == 'Linux' && matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build binaries
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: |
          cargo build --release -p workmesh --target ${{ matrix.target }}
          cargo build --release -p workmesh-mcp --target ${{ matrix.target }}

      - name: Package (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME}"
          dir="workmesh-${version}-${{ matrix.target }}"
          mkdir -p "${dir}"
          cp "target/${{ matrix.target }}/release/workmesh${{ matrix.ext }}" "${dir}/"
          cp "target/${{ matrix.target }}/release/workmesh-mcp${{ matrix.ext }}" "${dir}/"
          cp "README.md" "${dir}/" || true
          cp "LICENSE" "${dir}/" || true
          tar -czf "${dir}.tar.gz" "${dir}"
          echo "asset=${dir}.tar.gz" >> "$GITHUB_OUTPUT"
        id: pkg_unix

      - name: Package (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF_NAME
          $dir = "workmesh-$version-${{ matrix.target }}"
          New-Item -ItemType Directory -Force -Path $dir | Out-Null
          Copy-Item "target\\${{ matrix.target }}\\release\\workmesh${{ matrix.ext }}" "$dir\\"
          Copy-Item "target\\${{ matrix.target }}\\release\\workmesh-mcp${{ matrix.ext }}" "$dir\\"
          if (Test-Path "README.md") { Copy-Item "README.md" "$dir\\" }
          if (Test-Path "LICENSE") { Copy-Item "LICENSE" "$dir\\" }
          $zip = "$dir.zip"
          Compress-Archive -Path "$dir\\*" -DestinationPath $zip -Force
          "asset=$zip" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        id: pkg_win

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.tar.gz
            *.zip
