@startuml
title WorkMesh Developer Experience Workflow (Phases + Actors)

skinparam shadowing false
skinparam backgroundColor white

skinparam note {
  BackgroundColor #FFF9DB
  BorderColor #D09B2C
  FontColor #111111
}

skinparam sequence {
  ArrowColor #222222
  LifeLineBorderColor #222222
  LifeLineBackgroundColor #FFFFFF
  ParticipantBorderColor #222222
  ParticipantBackgroundColor #F7F7F7
  ParticipantFontColor #111111
  BoxBorderColor #222222
  BoxBackgroundColor #F7F7F7
  BoxFontColor #111111
}

actor "Developer / Agent" as A
participant "WorkMesh\n(CLI or MCP)" as W
participant "Repo working tree\n(docs/ + workmesh/)" as R
participant "Global sessions\n(~/.workmesh)" as G

note over A,W
Commands can be run directly (CLI) or via your coding agent (MCP).
The phase separators indicate when a command is typically used.
end note

== Phase 1: Bootstrap (run once per repo) ==
A -> W : bootstrap [--project-id <id>] [--feature "..."]
W -> R : detect state, then initialize or migrate to workmesh/
note right of R
Creates/updates:
- docs/projects/<project-id>/
- workmesh/tasks/task-001 - ...
- workmesh/context.json
end note
A -> W : index-rebuild (optional, first run)
W -> R : write workmesh/.index/tasks.jsonl
A -> W : context set (optional override)
W -> R : write workmesh/context.json
A -> W : truth propose / truth accept (as decisions solidify)
W -> R : append workmesh/truth/events.jsonl

== Phase 2: Daily loop (many times) ==
A -> W : ready --json
W -> R : read tasks + derived index
A -> W : claim <task> (lease)
W -> R : update lease metadata (touch default)
A -> W : set-status <task> "In Progress"
W -> R : write front matter + timestamps
A -> W : note / set-section (capture context)
W -> R : append to Notes / Implementation Notes
alt task completed
  A -> W : set-status <task> Done
  W -> R : mark done (touch default)
else pausing work
  note over A,W
  Keep status In Progress when you intend to resume soon.
  end note
end
A -> W : release <task>
W -> R : clear lease metadata

== Phase 3: Continuity (on compaction/reboot/context switches) ==
A -> W : checkpoint (repo-local)
W -> R : write checkpoint JSON + Markdown
A -> W : session save (global, optional/auto)
W -> G : append sessions/events.jsonl + update sessions/current.json
A -> W : resume / session resume
W -> R : print resume steps + show context + list accepted truths

== Phase 4: History + hygiene (periodic) ==
A -> W : archive (date-based)
W -> R : move Done tasks -> workmesh/archive/YYYY-MM/
A -> W : graph-export / issues-export
W -> R : export snapshots for tooling/analysis

@enduml
